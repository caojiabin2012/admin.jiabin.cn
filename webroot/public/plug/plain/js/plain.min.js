/*
 build time: Sep 17th,2013 13:49
 author: jiejie.zhuo
 */
(function(m){function f(c){if("undefined"!=typeof e[c])return e[c];e[c]=new Image;e[c].src=k.imageSrc+c;return e[c]}function q(c){if("undefined"!=typeof e[c])return e[c];e[c]=new Audio;e[c].src=k.soundSrc+c;return e[c]}function o(c){k.isMobile||(c=q(c),c.currentTime=0,c.play())}function r(c,h){for(var f=c.length,d=0,g=f;g--;){var i=c[g];e[i]=new Image;e[i].onload=function(){d++;f==d&&h()};e[i].src=k.imageSrc+i}}var e=[],d=m("#game-box"),h=d.get(0).getContext("2d"),g,i,w={show:function(c){m("#content").html(c);
m("#modal").removeClass("hide")},hide:function(){m("#modal").addClass("hide")}},k={imageSrc:"images/",soundSrc:"sounds/",loadImg:["bg.jpg","loading1.png","loading2.png","loading3.png","logo.png"],gameImg:"cartridge.png cartridge_power.png die1.png die2.png me.png plain1.png plain2.png plain3.png plain2_hurt.png plain3_hurt.png plain1_die1.png plain1_die2.png plain1_die3.png plain2_die1.png plain2_die2.png plain2_die3.png plain2_die4.png plain3_die1.png plain3_die2.png plain3_die3.png plain3_die4.png plain3_die5.png plain3_die6.png me_die1.png me_die2.png me_die3.png me_die4.png prop1.png prop2.png bomb.png me_2.png plain3_2.png".split(" "),
gameSound:"achievement.mp3 plain2_die.mp3 plain3_die.mp3 fire_bullet.mp3 game_music.mp3 game_over.mp3 get_bomb.mp3 get_double_laser.mp3 show_prop.mp3 plain1_die.mp3 use_bomb.mp3".split(" "),gameSpeed:8,cartridgeSpeed:10,isMobile:navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|mobile)/)},p=function(){var c=m(window).width(),f=m(window).height();i=800>f?f:800;g=480>c?c:480;d.attr({height:i,width:g}).offset({top:(f-i)/2});h.font="30px Microsoft YaHei";h.fillStyle="#333"};r(k.loadImg,
function(){for(var c=0,p=setInterval(function(){var d=f("bg.jpg");h.drawImage(d,0,0,d.width,d.height);var d=f("logo.png"),e=d.width;h.drawImage(d,(g-e)/2,100,e,d.height);600==c&&(c=0);d=f("loading"+(parseInt(c/200)+1)+".png");e=d.width;h.drawImage(d,(g-e)/2,220,e,d.height);c++},1),s=k.gameSound,t=s.length,u=0,v=t;v--;){var n=s[v];e[n]=new Audio;e[n].addEventListener("canplaythrough",function(){u++;t==u&&r(k.gameImg,function(){clearInterval(p);var c=function(a){this.type=a;this.status="show";this.isDeleted=
!1;this.modelImg;this.getSound;switch(a){case 1:this.modelImg="prop1.png";this.getSound="get_bomb.mp3";break;case 2:this.modelImg="prop2.png",this.getSound="get_double_laser.mp3"}this.model=f(this.modelImg);this.width=g/480*this.model.width;this.height=this.model.height/this.model.width*this.width;this.x=Math.random()*(g-this.width);this.y=-this.height;var j=this.speed=6,c=this.animateTime=70;this.showType="down";this.show=function(){this.animateTime<=c/2&&(this.showType="up");h.drawImage(this.model,
this.x,this.y,this.width,this.height);if(d(this))this.isDeleted=!0,this.byGain();else{var b=(i+this.height)/3/(c/2);this.speed=b;this.y="down"==this.showType?this.y+b:this.y-b;this.animateTime--;0>=this.animateTime&&(this.speed=j,this.status="move")}};this.move=function(){this.y+=this.speed;h.drawImage(this.model,this.x,this.y,this.width,this.height);d(this)&&(this.isDeleted=!0,this.byGain())};this.byGain=function(){switch(this.type){case 1:b.player.bomb++;break;case 2:b.player.attackPower=!0,b.player.attackPowerClock=
setTimeout(function(){b.player.attackPower=!1},15E3)}o(this.getSound)};var d=function(a){var l=a.x;if(a.x+a.width<b.player.x||l>b.player.x+b.player.width)return!1;l=a.y+("move"==a.status?a.speed:"down"==a.showType?a.speed:-a.speed);return(a.y+a.height>b.player.y||l+a.height<b.player.y)&&b.player.lastY>a.y+a.height?!1:!0}},e=function(a){this.type=a;this.hp;this.height;this.width;this.maxSpeed;this.dieTime;this.status=!0;switch(a){case 1:this.hp=1;this.score=1E3;this.maxSpeed=5;this.dieTime=60;break;
case 2:this.hp=8;this.score=8E3;this.maxSpeed=2;this.dieTime=80;break;case 3:this.hp=18,this.score=3E4,this.maxSpeed=1,this.dieTime=120}this.dieSound="plain"+this.type+"_die.mp3";this.modelimg="plain"+this.type+".png";this.model=f(this.modelimg);3==this.type&&(this.modelimg2="plain3_2.png",this.model2=f(this.modelimg2));this.width=g/480*this.model.width;this.height=this.width/this.model.width*this.model.height;this.x=Math.random()*(g-this.width);this.y=-this.height;a=10<b.time/1E3?10:b.time/1E3;this.speed=
Math.random()*(a-1)+1;this.speed=0.5>this.speed?0.5*Math.random()+0.5:this.speed;this.speed=this.speed>this.maxSpeed?this.maxSpeed:this.speed;this.show=function(){this.type==3?h.drawImage(b.time%30>15?this.model:this.model2,this.x,this.y,this.width,this.height):h.drawImage(this.model,this.x,this.y,this.width,this.height)};this.die=function(){var a=this.type,l=this.x,j=this.y,c=this.width,d=this.height;b.plainsDies.push(new function(b){this.animationTime=b;this.call=function(){if(!(this.animationTime<=
0)){var e=f("plain"+a+"_die"+(parseInt((b-this.animationTime)/20)+1)+".png");h.drawImage(e,l,j,c,d);this.animationTime--}}}(this.dieTime));b.score=b.score+this.score;this.status=false};var j=this.hp;this.byAttack=function(){this.hp--;if(this.hp<=0){this.die();o(this.dieSound)}else if(this.hp<=j/3)this.model=f("plain"+this.type+"_hurt.png")}},n=function(b,a,c,d){this.model=f(2==c?"cartridge_power.png":"cartridge.png");this.width=g/480*this.model.width;this.height=this.width/this.model.width*this.model.height;
this.x=b+(d.width-this.width)/2;this.y=a-this.height},a={};a.x;a.y;a.lastX;a.lastY;a.bomb=0;a.status=!0;a.model=f("me.png");a.model2=f("me_2.png");a.width=g/480*a.model.width;a.height=a.width/a.model.width*a.model.height;a.move=function(b,j){a.lastX=a.x;a.lastY=a.y;a.x=b-a.width/2;a.y=j-a.height/2;a.x=a.x>g-a.width?g-a.width:a.x;a.x=0>a.x?0:a.x;a.y=a.y>i-a.height?i-a.height:a.y;a.y=0>a.y?0:a.y};a.moveing=function(){a.status&&(h.drawImage(15<b.time%30?a.model:a.model2,a.x,a.y,a.width,a.height),a.attacking())};
a.cartridges=[];a.attackTime=0;a.attackPower=!1;a.attack=function(){if(a.status&&(a.attackTime++,0==a.attackTime*b.refreshInterval%(20*b.refreshInterval))){a.attackTime=0;o("fire_bullet.mp3");var l;l=a.attackPower?[new n(a.x-a.width/5,a.y,2,a),new n(a.x+a.width/5,a.y,2,a)]:[new n(a.x,a.y,1,a)];Array.prototype.push.apply(a.cartridges,l)}};a.attacking=function(){a.attack();var l=k.cartridgeSpeed,j=a.cartridges.length;a:for(;j--;){var c=a.cartridges[j];h.drawImage(c.model,c.x,c.y,c.width,c.height);if(0>=
c.y){a.cartridges.splice(j,1);continue a}var d=b.plains.length;for(;d--;){var e=b.plains[d],f=c.x,g=c.y,i=g-l;if(f>e.x&&f<e.x+e.width&&i<e.y+e.height+e.speed&&g>=e.y+e.height){e.byAttack();a.cartridges.splice(j,1);continue a}}c.y-=l}};a.useBomb=function(){if(!(0>=b.player.bomb)){b.player.bomb--;o("use_bomb.mp3");for(var a=b.plains.length;a--;)b.plains[a].die()}};a.die=function(){function c(){var a=4*j;this.animationTime=4*j;this.call=function(){1==this.animationTime&&b.over();var c=f("me_die"+(parseInt((a-
this.animationTime)/j)+1)+".png");h.drawImage(c,d,e,i,g);this.animationTime--}}if(a.status){a.status=!1;o("game_over.mp3");var j=20,d=a.x,e=a.y,g=a.height,i=a.width;b.plainsDies.push(new c)}};var b={score:0,time:0};b.player=a;b.bgImg=f("bg.jpg");b.refreshInterval=k.gameSpeed;b.refresh=function(){b.time++;b.bgScroll();b.plainsScroll();b.plainsDying();b.player.moveing();b.propShow();b.refreshMessage()};b.bgScrollTime=0;b.bgScroll=function(){var a=b.bgImg.height,c=b.bgImg.width;b.bgScrollTime+=0.5;b.bgScrollTime>
a&&(b.bgScrollTime=0);h.drawImage(b.bgImg,0,b.bgScrollTime-a,c,a);h.drawImage(b.bgImg,0,b.bgScrollTime,c,a)};b.props=[];b.addProp=function(){0==b.time*b.refreshInterval%1E4&&(b.props.push(new c(parseInt(1.8*Math.random()+1.1))),o("show_prop.mp3"))};b.propShow=function(){b.addProp();for(var a=b.props.length;a--;){var c=b.props[a];!0==c.isDeleted?b.props.splice(a,1):(c[c.status](),c.y>i&&b.props.splice(a,1))}};b.plains=[];b.plainsNum=0;b.addPlain=function(){if(0==b.time%60)switch(26==b.plainsNum&&(b.plainsNum=
0),b.plainsNum++,!0){case 0==b.plainsNum%13:b.plains.push(new e(3));break;case 0==b.plainsNum%6:b.plains.push(new e(2));break;default:b.plains.push(new e(1))}};b.plainsScroll=function(){b.addPlain();for(var a=b.plains.length;a--;){var c=b.plains[a];if(c.y>i||!1==c.status)b.plains.splice(a,1);else{c.show();var d=[c.x,c.y],e=[c.x+c.width,c.y+c.height],f=[b.player.x+b.player.width/3,b.player.y],g=[b.player.x+2*b.player.width/3,b.player.y+2*b.player.height/3],d=[Math.max(d[0],f[0]),Math.max(d[1],f[1])],
e=[Math.min(e[0],g[0]),Math.min(e[1],g[1])];d[0]<e[0]&&d[1]<e[1]&&b.player.die();c.y+=c.speed}}};b.plainsDies=[];b.plainsDying=function(){for(var a=b.plainsDies.length;a--;){var c=b.plainsDies[a];0==c.animationTime?b.plainsDies.splice(a,1):c.call()}};b.over=function(){b.music.pause();d.removeClass("playing");k.isMobile?d.get(0).removeEventListener("touchmove"):d.off("mousemove");d.off("click");clearInterval(b.clock);w.show(b.score)};b.clear=function(){b.player.x=(g-b.player.width)/2;b.player.y=i-
b.player.height;b.plains=[];b.plainsDies=[];b.plainsNum=0;b.time=0;b.bgScrollTime=0;b.score=0;b.player.status=!0;b.player.bomb=0;b.player.attackPower=!1;clearTimeout(b.player.attackPowerClock)};b.music=q("game_music.mp3");b.start=function(){b.music.currentTime=0;b.music.loop=!0;b.music.play();d.addClass("playing");d.on("click",b.player.useBomb);if(k.isMobile)d.get(0).addEventListener("touchmove",function(a){a.preventDefault();var c=a.targetTouches[0],a=c.pageX-d.offset().left,c=c.pageY-d.offset().top;
b.player.move(a,c)});else d.on("mousemove",function(a){var a=a?a:window.event,c=a.clientX-d.offset().left,a=a.clientY-d.offset().top;b.player.move(c,a)});w.hide();b.clear();b.clock=setInterval(function(){b.refresh()},b.refreshInterval)};b.refreshMessage=function(){h.fillText(b.score,20,44);if(0<b.player.bomb){var a=f("bomb.png");h.drawImage(a,10,i-a.height-10,a.width,a.height);h.fillText(b.player.bomb,20+a.width,i-a.height+28)}};b.start();m("#modal").on("click","button",b.start)})});e[n].src=k.soundSrc+
n}});p();m(window).on("resize",p)})(jQuery);